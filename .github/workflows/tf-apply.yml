################################################################################
# GitHub Actions Workflow: Deploy MedPal Infrastructure
################################################################################
#
# DESCRIPTION (Non-Technical):
#   This is an automated deployment script that runs in GitHub.
#   When you click "Run workflow", it:
#   1. Gets the latest code from your repository
#   2. Installs Terraform
#   3. Validates the infrastructure code
#   4. Plans the changes (shows what will be created)
#   5. Applies the changes (actually creates/updates AWS resources)
#
# DESCRIPTION (Technical):
#   This GitHub Actions workflow implements the Terraform init/validate/plan/apply pipeline
#   with manual trigger (workflow_dispatch) for controlled deployments.
#
# HOW TO USE:
#   1. Go to GitHub Actions tab in your repository
#   2. Click "Deploy MedPal Infrastructure" workflow
#   3. Click "Run workflow" button
#   4. Wait for the workflow to complete
#   5. Check the output for the Webhook URL to add to Twilio
#
# REQUIREMENTS:
#   - AWS credentials must be configured in GitHub Secrets
#   - Add these secrets to your repository:
#     * AWS_ACCESS_KEY_ID: Your AWS access key
#     * AWS_SECRET_ACCESS_KEY: Your AWS secret key
#
# LEARN MORE:
#   - Terraform: https://www.terraform.io/
#   - GitHub Actions: https://docs.github.com/en/actions
#
################################################################################

name: Deploy MedPal Infrastructure

# Trigger Configuration
# ============================================================================
# This workflow triggers manually (not automatically on every commit)
# Manual trigger is safer for infrastructure changes
# workflow_dispatch: Allows you to manually start this workflow from GitHub UI

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      confirm_deploy:
        description: 'Type "deploy" to confirm deployment'
        required: true
        default: ''


# Permissions Configuration
# ============================================================================
# This restricts what the GitHub Actions workflow can do
# We only need to read the repository contents

permissions:
  contents: read
  id-token: write  # Needed if using OIDC for AWS credentials


# Jobs Definition
# ============================================================================
# A workflow contains one or more jobs that run sequentially or in parallel

jobs:
  
  # =========================================================================
  # Job 1: Validate Terraform Configuration
  # =========================================================================
  # This job checks for syntax errors before applying

  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Clone the repository to get the code
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for better context
      
      # Step 2: Install Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
      
      # Step 3: Check Terraform formatting
      - name: Terraform Format Check
        working-directory: medpal-v1/infra
        run: |
          terraform fmt -check -recursive || {
            echo "‚ùå Terraform formatting issues found"
            echo "Run: terraform fmt -recursive"
            exit 1
          }
      
      # Step 4: Initialize Terraform (downloads providers)
      - name: Terraform Init
        working-directory: medpal-v1/infra
        run: terraform init -backend=false  # Skip backend for validation only
      
      # Step 5: Validate Terraform syntax
      - name: Terraform Validate
        working-directory: medpal-v1/infra
        run: terraform validate


  # =========================================================================
  # Job 2: Plan Infrastructure Changes
  # =========================================================================
  # This job shows what changes will be made (useful for review)

  plan:
    name: Plan Infrastructure
    runs-on: ubuntu-latest
    needs: validate
    
    # Only run if everything validated successfully
    # Continue on error allows the workflow to show what would fail
    continue-on-error: false
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
      
      # Configure AWS credentials (from GitHub Secrets)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: us-east-1
      
      # Initialize Terraform
      - name: Terraform Init
        working-directory: medpal-v1/infra
        run: terraform init
      
      # Create plan (shows what will change)
      - name: Terraform Plan
        working-directory: medpal-v1/infra
        run: |
          terraform plan \
            -out=tfplan \
            -lock=false \
            -no-color
        continue-on-error: true
      
      # Save plan as artifact for review
      - name: Save Plan
        uses: actions/upload-artifact@v3
        with:
          name: tfplan
          path: medpal-v1/infra/tfplan
          retention-days: 1


  # =========================================================================
  # Job 3: Apply Infrastructure Changes
  # =========================================================================
  # This job actually creates/updates AWS resources

  apply:
    name: Apply Infrastructure
    runs-on: ubuntu-latest
    needs: plan
    
    # Only run with manual approval
    if: github.event.inputs.confirm_deploy == 'deploy'
    
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
      
      # Configure AWS credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: us-east-1
      
      # Initialize Terraform
      - name: Terraform Init
        working-directory: medpal-v1/infra
        run: terraform init
      
      # Apply the infrastructure changes
      - name: Terraform Apply
        working-directory: medpal-v1/infra
        run: |
          terraform apply \
            -auto-approve \
            -lock=true \
            -input=false
      
      # Get the outputs (including Webhook URL)
      - name: Capture Outputs
        working-directory: medpal-v1/infra
        run: |
          echo "=== Deployment Outputs ===" | tee deployment-output.txt
          terraform output -no-color | tee -a deployment-output.txt
      
      # Save outputs for easy access
      - name: Save Outputs
        uses: actions/upload-artifact@v3
        with:
          name: deployment-outputs
          path: medpal-v1/infra/deployment-output.txt
          retention-days: 30
      
      # Post deployment status
      - name: Deployment Success
        run: |
          echo "‚úÖ MedPal infrastructure deployed successfully!"
          echo ""
          echo "üìù Next Steps:"
          echo "1. Download the deployment outputs"
          echo "2. Copy the webhook_url"
          echo "3. Add it to your Twilio webhook configuration"
          echo ""
          echo "üîó Webhook URL output above"


# Workflow-Level Configuration
# ============================================================================
# These settings apply to the entire workflow

concurrency:
  # Prevent multiple deployments running simultaneously
  group: deploy-medpal
  cancel-in-progress: false


# Success/Failure Notifications (Optional)
# ============================================================================
# You can add Slack notifications, emails, etc. here
# Example Slack webhook:
# - name: Notify Slack on Success
#   if: success()
#   uses: slackapi/slack-github-action@v1.27.0
#   with:
#     webhook-url: ${{ secrets.SLACK_WEBHOOK }}
